<?xml version="1.0"?>
<!-- This file is part of the DITA Open Toolkit project hosted on 
     Sourceforge.net. See the accompanying license.txt file for 
     applicable licenses.-->
<!-- (c) Copyright IBM Corp. 2006 All Rights Reserved. -->
<project xmlns:dita="http://dita-ot.sourceforge.net" name="DOST" default="init">

  <property name="src.dir" value="${basedir}"/>
  <!--<property file="${basedir}/local.properties"/>-->

  <!-- Initialize DITA-OT base directory -->
  <dirname property="ant.file.DOST.dir" file="${ant.file.DOST}" />
  <!-- Set dita.dir here rather than in conditions below -->
  <property name="dita.dir" value="${ant.file.DOST.dir}"/>
  <!-- local.properties is read by the imported local.properties.xml -->
  <import file="${ant.file.DOST.dir}/local.properties.xml"/>

  <!-- ant.file.DOST is set by definition.
      So, how can ant.file.DOST.dir not be set?
  <condition property="dita.dir" value="${ant.file.DOST.dir}">
    <not>
      <isset property="dita.dir" />
    </not>
  </condition>
  <condition property="dita.dir" value="${basedir}">
    <not>
      <isset property="dita.dir" />
    </not>
  </condition>
  -->
  <condition property="dost.ant.jar.on.java.cp">
    <matches pattern=".*\bant\.jar\b.*" string="${java.class.path}"/>
  </condition>
  <condition property="dost.ant-launcher.jar.on.java.cp">
    <matches pattern=".*\bant-launcher\.jar\b.*" string="${java.class.path}"/>
  </condition>
  
  <!-- Minimal path for ant jars. May not need ant.jar for build. -->
  <path id="dost.local.ant.path">
    <pathelement location="${dost.ant-launcher.jar}"/>
    <pathelement location="${dost.ant-resolver.jar}"/>
    <pathelement location="${dost.ant.jar}"/>
  </path>
  
  <path id="dost.class.path">
    <dita:extension id="dita.conductor.lib.import" behavior="org.dita.dost.platform.ImportAntLibAction"/>
    <pathelement location="${dita.dir}/lib/dost.jar"/>
  </path>

  <target name="start-recursive-ant" unless="dost.jars.on.classpath">
    <!--
    <fail unless="dost.ant.launcher.available">
Ant launcher is not available on the classpath.
ant.jar or ant-launcher.jar must be on the starting classpath or in the distribution lib directory.
FIXME See {reference to dita-ot manual goes here}.
    </fail>
    -->
    
    <propertyset id="dost.properties">
      <propertyref prefix="dost"/>
    </propertyset>
    
    <propertyset id="dita.properties">
      <propertyref prefix="dita"/>
    </propertyset>
    
    <propertyset id="args.properties">
      <propertyref prefix="args"/>
    </propertyset>
    
    <propertyset id="maybe.properties">
      <propertyref prefix="maybe"/>
    </propertyset>
    
    <propertyset id="version.properties">
      <propertyref regex=".*version.*"/>
    </propertyset>
    
    <propertyset id="dir.properties">
      <propertyref regex=".*\bdir\b.*"/>
    </propertyset>
    
    <propertyset id="tmp.properties">
      <propertyref regex=".*\bte?mp\b.*"/>
    </propertyset>
    
    <propertyset id="parser.properties">
      <propertyref regex=".*parser.*"/>
    </propertyset>
    
    <propertyset id="execute.properties">
      <propertyset refid="dost.properties"/>
      <propertyset refid="dita.properties"/>
      <propertyset refid="args.properties"/>
      <propertyset refid="maybe.properties"/>
      <propertyset refid="version.properties"/>
      <propertyset refid="dir.properties"/>
      <propertyset refid="tmp.properties"/>
      <propertyset refid="parser.properties"/>
      <propertyref name="collator"/>
      <propertyref name="transtype"/>
    </propertyset>
    
    <!--<echo>execute.properties ${toString:execute.properties}</echo>-->
    
    <antcall target="recursive-ant" inheritAll="false" inheritRefs="true">
      <propertyset refid="execute.properties"/>
    </antcall>
    
  </target>

  <target name="recursive-ant">
    <echo>dost.run.classpath ${toString:dost.run.classpath}</echo>
    <!-- Start a new instance of ant with necessary properties, and re-invoke this build file. -->
    <java
        classname="org.apache.tools.ant.launch.Launcher"
        fork="true"
        maxmemory="512m"
        failonerror="true"
        dir="${ant.file.DOST.dir}"
        taskname="recursive_ant"
        newenvironment="true"
    >
      <classpath>
        <path refid="dost.run.classpath" />
      </classpath>
      <env key="ANT_OPTS"
        value="-Djavax.xml.transform.TransformerFactory=net.sf.saxon.TransformerFactoryImpl ${local.ant.opts}"/>
      <env key="CLASSPATH" value="${toString:dost.run.classpath}"/>
      <syspropertyset refid="execute.properties"/>
      <!--<arg value="-verbose"/>-->
      <arg value="-f"/>
      <arg value="${ant.file.DOST}"/>
      <arg value="original_init"/>
    </java>
  </target>

  <target name="init" depends="check-dost-jars-available, start-recursive-ant, original_init"/>
  
  <target name="original_init" if="dost.jars.on.classpath" depends="check-dost-jars-available, verify-dost-run-classpath">
    <dita-ot-fail id="DOTA001F">
      <condition>
        <and>
          <dita:extension id="dita.conductor.transtype.check" behavior="org.dita.dost.platform.CheckTranstypeAction"/>
        </and>
      </condition>
      <param name="1" value="${transtype}"/>
    </dita-ot-fail>
    <condition property="transtarget" value="pdf2" else="${transtype}">
      <equals arg1="${transtype}" arg2="pdf" casesensitive="false"/>
    </condition>
    <condition property="clean.temp" value="true">
      <not><isset property="clean.temp"/></not>
    </condition>
    <condition property="clean-temp.skip">
      <isfalse value="${clean.temp}"/>
    </condition>
    <antcall>
      <target name="dita2${transtarget}"/>
      <target name="clean-temp"/>
    </antcall>
  </target>
  
  <dita:extension id="dita.conductor.plugin" behavior="org.dita.dost.platform.ImportPluginInfoAction"/>
  <dita:extension id="dita.conductor.target" behavior="org.dita.dost.platform.InsertAction"/>
  <dita:extension id="dita.conductor.target.relative" behavior="org.dita.dost.platform.InsertAntActionRelative"/>
  
  <target name="help">
    <echo level="info">Mandatory properties:</echo>
    <echo level="info"/>
    <echo level="info">  args.input=&lt;file&gt;</echo>
    <echo level="info">    Path and name of the input file.</echo>
    <echo level="info"/>
    <echo level="info">  transtype={<dita:extension id="dita.conductor.transtype.check" behavior="org.dita.dost.platform.ListTranstypeAction" separator="|"/>}</echo>
    <echo level="info">    Transformation type.</echo>
    <echo level="info"/>
    <echo level="info">Optional properties:</echo>
    <echo level="info"/>
    <echo level="info">  args.logdir=&lt;dir&gt;</echo>
    <echo level="info">    Log directory.</echo>
    <echo level="info"/>
    <echo level="info">  args.draft={yes|no}</echo>
    <echo level="info">    Specify whether to output draft info. Default is "no".</echo>
    <echo level="info"/>
    <echo level="info">  args.ftr=&lt;file&gt;</echo>
    <echo level="info">    File to be placed in the BODY running-footing area.</echo>
    <echo level="info"/>
    <echo level="info">  args.hdr=&lt;file&gt;</echo>
    <echo level="info">    File to be placed in the BODY running-heading area.</echo>
    <echo level="info"/>
    <echo level="info">  args.hdf=&lt;file&gt;</echo>
    <echo level="info">    File to be placed in the HEAD area.</echo>
    <echo level="info"/>
    <echo level="info">  args.csspath=&lt;file|url&gt;</echo>
    <echo level="info">    Path for CSS reference.</echo>
    <echo level="info"/>
    <echo level="info">  args.css=&lt;file&gt;</echo>
    <echo level="info">    User CSS file.</echo>
    <echo level="info"/>
    <echo level="info">  args.cssroot=&lt;dir&gt;</echo>
    <echo level="info">    Root directory for user specified CSS file.</echo>
    <echo level="info"/>
    <echo level="info">  args.copycss={yes|no}</echo>
    <echo level="info">    Copy user specified CSS files. Default is "no".</echo>
    <echo level="info"/>
    <echo level="info">  args.indexshow={yes|no}</echo>
    <echo level="info">    Index entries should display within the body of the text itself. Default is "no".</echo>
    <echo level="info"/>
    <echo level="info">  args.outext=&lt;ext&gt;</echo>
    <echo level="info">    Output file extension for generated XHTML files. Default is ".html".</echo>
    <echo level="info"/>
    <echo level="info">  args.xsl=&lt;file&gt;</echo>
    <echo level="info">    XSLT file used to replace the default XSLT file.</echo>
    <echo level="info"/>
    <echo level="info">  args.xsl.pdf=&lt;file&gt;</echo>
    <echo level="info">    XSLT file used to replace the default XSLT file when transforming PDF.</echo>
    <echo level="info"/>
    <echo level="info">  args.odt.include.rellinks={none|all|nofamily}</echo>
    <echo level="info">    Determine which links are included in the ODT. Default is "none".</echo>
    <echo level="info"/>
    <echo level="info">  args.javahelp.toc=&lt;file&gt;</echo>
    <echo level="info">    Root file name of the output javahelp toc file in javahelp transformation. Default is the name of the input ditamap file.</echo>
    <echo level="info"/>
    <echo level="info">  args.javahelp.map=&lt;file&gt;</echo>
    <echo level="info">    Root file name of the output javahelp map file in javahelp transformation. Default is the name of the input ditamap file.</echo>
    <echo level="info"/>
    <echo level="info">  args.eclipsehelp.toc=&lt;file&gt;</echo>
    <echo level="info">    Root file name of the output eclipsehelp toc file in eclipsehelp transformation. Default is the name of the input ditamap file.</echo>
    <echo level="info"/>
    <echo level="info">  args.eclipsecontent.toc=&lt;file&gt;</echo>
    <echo level="info">    Root file name of the output Eclipse content provider toc file in eclipsecontent transformation. Default is the name of the input ditamap file.</echo>
    <echo level="info"/>
    <echo level="info">  args.debug={yes|no}</echo>
    <echo level="info">    Extra debug information should be included in the log. Default is "no".</echo>
    <echo level="info"/>
    <echo level="info">  args.grammar.cache={yes|no}</echo>
    <echo level="info">    Use grammar pool caching when parsing dita files. Default is "yes".</echo>
    <echo level="info"/>
    <echo level="info">  args.odt.img.embed={yes|no}</echo>
    <echo level="info">    Embedding images as binary data in ODT transform. Default is "yes".</echo>
    <echo level="info"/>
    <echo level="info">  args.xhtml.toc=&lt;file&gt;</echo>
    <echo level="info">    Root file name of the output XHTML toc file in XHTML transformation.</echo>
    <echo level="info"/>
    <echo level="info">  args.xhtml.classattr={yes|no}</echo>
    <echo level="info">    DITA element names and ancestry are included in XHTML class attributes. Default is "yes".</echo>
    <echo level="info"/>
    <echo level="info">  args.gen.task.lbl={YES|NO}</echo>
    <echo level="info">    DITA Task sections should get headings. Default is "NO".</echo>
    <echo level="info"/>
    <echo level="info">  artlbl={yes|no}</echo>
    <echo level="info">    Specify whether to output artwork filenames.</echo>
    <echo level="info"/>
    <echo level="info">  basedir=&lt;dir&gt;</echo>
    <echo level="info">    Working directory.</echo>
    <echo level="info"/>
    <echo level="info">  clean.temp={yes|no}</echo>
    <echo level="info">    Clean the temp directory before each build. Default is "yes".</echo>
    <echo level="info"/>
    <echo level="info">  dita.dir=&lt;dir&gt;</echo>
    <echo level="info">    Toolkit's home directory.</echo>
    <echo level="info"/>
    <echo level="info">  dita.temp.dir=&lt;dir&gt;</echo>
    <echo level="info">    Temporary directory.</echo>
    <echo level="info"/>
    <echo level="info">  dita.extname=&lt;ext&gt;</echo>
    <echo level="info">    File extension name to be used in the temp directory. Default is ".xml".</echo>
    <echo level="info"/>
    <echo level="info">  args.filter=&lt;file&gt;</echo>
    <echo level="info">    Name of the file that contains the filter/flaggin/revision information.</echo>
    <echo level="info"/>
    <echo level="info">  generate.copy.outer={1|2|3}</echo>
    <echo level="info">    Specify how to deal with the overflowing dita/topic files. Default is "1".</echo>
    <echo level="info"/>
    <echo level="info">  onlytopic.in.map={true|false}</echo>
    <echo level="info">    Make dita processor only resolve dita/topic files which are referenced by primary ditamap files. Default is "false".</echo>
    <echo level="info"/>
    <echo level="info">  out.dir=&lt;dir&gt;</echo>
    <echo level="info">    Output directory.</echo>
    <echo level="info"/>
    <echo level="info">  outer.control={fail|warn|quiet}</echo>
    <echo level="info">    Respond to the overflowing dita/topic files. Default is "warn".</echo>
    <echo level="info"/>
    <echo level="info">  retain.topic.fo</echo>
    <echo level="info">    Temporary FO file should be preserved in the output directory. Specify any value, such as "yes", to preserve the file.</echo>
    <echo level="info"/>
    <echo level="info">  validate={true|false}</echo>
    <echo level="info">    Input files are validated. Default is "true".</echo>
  </target>

</project>
